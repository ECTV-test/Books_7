# Books_6 — План внедрения (по этапам)

Цель: добавлять функции **по шагам**, не ломая уже рабочее.

## Этап 1 — Chapters (главы) + навигация

**Формат в тексте:**
- Вставляем метку главы в текст книги:
  - `[[CHAPTER: Chapter 6 — The Sandwich Plan]]`
- Метка **не показывается** пользователю (скрываем в UI), но используется для построения списка глав.

**Fallback (гибрид):**
- Если меток `[[CHAPTER: ...]]` нет — пытаемся определить главы по правилу:
  - две пустые строки + короткий заголовок

**UI:**
- Кнопка `≡` появляется **у плеера слева**.
- По нажатию открывается bottom sheet со списком глав.
- Выбор главы → переход к началу главы (по lineIndex).

## Этап 2 — Прогресс по пакетам языка (и логика при смене языка книги)

**Правило:**
- Прогресс хранится отдельно для каждой комбинации:
  - `bookId + mode(read/listen) + sourceLang(bookLang) + targetLang(translationLang)`

**При смене Book Language (sourceLang):**
- если сохранён прогресс для этой пары → открываем на нём
- если нет → старт с начала (или с первой главы)

## Этап 3 — Закладки: маркер + toggle

**Маркер в тексте:**
- Тонкая вертикальная полоска слева у строки, где есть закладка.

**Popover (слово/строка):**
- Кнопка “bookmark” работает как **toggle**:
  - нажал → добавил
  - нажал ещё раз → удалил
- Иконка должна меняться (outline ↔ filled), чтобы было понятно состояние.

**Закладка по слову:**
- Сначала делаем безопасно: создаём закладку на строку.
- Дополнительно сохраняем якорь слова (`wordIndex` в строке) и при переходе можно коротко подсветить слово.
- Уточнение “полноценные word-bookmarks” можно сделать вторым шагом, чтобы не ломать подсветку по словам.

## Этап 4 — Прогресс у плеера

- В зоне плеера показываем:
  - процент текущего пакета (например `35%`)
  - рядом маленько `DE→RU`

Без лишних режимов/строк, чтобы не перегружать.

## Дальше (после стабилизации)

1) **Адаптация книг под уровни (A1/A2/B1)**
2) **Картинки по главам** (сначала в списке глав, не в тексте)
3) Порт во Flutter (структура файлов и ключи прогресса сохраняются)
4) ИИ-помощник с лимитами (usage limits)

