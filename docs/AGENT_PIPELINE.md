# Agent Pipeline — адаптация уровней + переводы

Этот документ описывает **батч-процесс** (offline/ручной запуск), который генерирует файлы книг для уровней A1/A2/B1 и языков EN/UK/RU/DE/PL/ES/FR.

## 1) Что генерируем

Рекомендуемая структура (одна книга = одна папка):

```
books/<bookId>/
  book.json
  cover.jpg
  levels/
    a1/
      book.en.txt
      book.uk.txt
      book.ru.txt
      book.de.txt
      book.pl.txt
      book.es.txt
      book.fr.txt
    a2/
      ...
    b1/
      ...
```

- `book.<lang>.txt` внутри уровня — это **язык книги (source text)**.
- Перевод (targetLang в UI) остаётся онлайновым через `/translate` + кэш (как сейчас), либо позже можно добавить файлы переводов по строкам.

## 2) Источник

- `sources/<bookId>.epub` или `sources/<bookId>.txt`
- Скрипт сам извлекает текст, нормализует строки и добавляет метки глав `[[CHAPTER: ...]]` (если в источнике их нет).

## 3) Как запускать

Вариант A (локально):
- хранить ключи в `.env` (не коммитить)
- запуск:
  - `node tools/adapt_and_translate.js --book tom-sawyer --levels a1,a2,b1 --langs en,uk,ru,de,pl,es,fr`

Вариант B (рекомендуется): через Cloudflare Worker gateway
- локальный скрипт **не хранит OpenAI ключ**, он вызывает ваш Worker:
  - `/adapt` (если добавим)
  - или уже существующие `/translate` + `/tts` (для отдельных задач)
- ключ OpenAI живёт в Worker secrets.

Плюсы gateway:
- ключи не утекут в repo
- единый кэш
- проще лимитировать/защитить

## 4) Инкрементальные прогоны (чтобы не платить заново)

Скрипт должен уметь:
- генерировать **только один уровень** (например только `a1`)
- генерировать **только один язык** (например только `ru`)
- пропускать файлы, которые уже существуют (если `--force` не задан)

## 5) Индекс каталога

После добавления/обновления `book.json`:
- запуск `python3 tools/build_index.py`
- он пересобирает `books/index.json`

## 6) “Почти CI” (безопасно)

- GitHub Actions ручной запуск (Run workflow), который:
  1) запускает скрипт генерации
  2) запускает `tools/build_index.py`
  3) делает commit результатов

Плюсы:
- ничего не запускается автоматически на каждом коммите
- контролируемый расход токенов

