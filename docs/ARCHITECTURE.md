# Books_6 — Архитектура (как сейчас работает)

## 1) Что где лежит

- **Frontend (GitHub Pages / WebView):** `index.html` + папка `books/`.
- **Каталог книг:** `books/index.json` (генерируется из `books/*/book.json`).
- **Книга:** `books/<bookId>/`:
  - `book.json` — метаданные (названия, уровень, длительность, cover и т.д.)
  - `book.txt` — текст по умолчанию (обычно EN)
  - `book.<lang>.txt` — текст книги на другом языке (например `book.uk.txt`, `book.ru.txt`)
  - `cover.jpg` — обложка

- **Backend-прокси:** `worker.js` (Cloudflare Worker)
  - `/translate` — перевод текста через OpenAI + кэш
  - `/tts` — озвучание через OpenAI TTS + кэш (ключ кэша учитывает `voice + speed + instructions + format + text`)

## 2) Роуты (экраны)

Внутри `index.html` есть простой роутер (`go(route)`):

- `catalog` — главный экран (каталог книг)
- `details` — описание выбранной книги
- `reader` — режим **Listen**
- `bireader` — режим **Read**
- `library` — **My Library** (прогрессы + закладки)

Кнопка «Назад в меню книг» использует **принудительный переход в `catalog`** (не браузерную историю), чтобы не было «прыжков» назад по действиям.

## 3) Загрузка книги и выбор языка книги

- Книга загружается функцией `loadBook(bookId, sourceLang)`.
- Сначала пытаемся загрузить файл **`book.<sourceLang>.txt`**.
- Если файла нет — fallback на **`book.txt`**.

Это значит:
- По умолчанию: `EN` (книга) + перевод UI/по умолчанию `UK`.
- Если пользователь выбирает язык книги `DE` — читаем `book.de.txt` и дальше переводим на выбранный язык перевода.

## 4) Перевод (строка/слово)

- Перевод строки (кнопка перевода строки / popover) идёт через Worker `/translate`.
- Перевод слова (тап по слову) тоже идёт через `/translate`, но отправляется **короткий текст (слово)**.

Кэш для перевода живёт в Worker (`caches.default`) и зависит от `target + text`.

> Примечание: UI поддерживает языки с кириллицей и диакритикой (PL/DE/FR/ES/…): токенизация слов использует безопасный regex (без `\p{L}`, чтобы не ловить белый экран в iOS WebView).

## 5) Озвучка (TTS)

- Озвучка строк идёт через Worker `/tts`.
- В запрос входят:
  - `text`
  - `voice` (male/female)
  - `speed` (Slow/Normal/Fast)
  - `instructions` (тон/стиль)

Кэш `/tts` учитывает `speed` в cacheKey, поэтому разные скорости — разные кэш-объекты.

## 6) Подсветка (Listen)

- Подсветка по строке и по словам завязана на активный индекс строки.
- Для некоторых платформ (iOS) применена логика, чтобы чтение не останавливалось после одной строки (из-за autoplay-ограничений) и корректно пропускались пустые строки.

## 7) Прогресс (важно)

Есть два слоя прогресса:

### 7.1) «Legacy» прогресс (по книге и режиму)
- Ключ: `book_progress::<bookId>::<routeName>`
- Хранится в `sessionStorage` (живёт до полной перезагрузки).

### 7.2) Прогресс по «пакету языков» (актуальный)
- Ключ: `book_pkg_progress::<bookId>::<mode>::<sourceLang>::<targetLang>`
  - `mode` = `listen` (route `reader`) или `read` (route `bireader`)
- Хранится в `localStorage` (или fallback в `sessionStorage`).
- Также хранится «последний использованный пакет»:
  - `book_last_pkg::<bookId>`

**Отображение:**
- В каталоге/Continue/Details — прогресс **последнего пакета**.
- В My Library — показываем несколько последних пакетов (сейчас — 3).

## 8) Закладки

- Закладки хранятся **по книге**:
  - ключ `bm:<bookId>`
- Каждая закладка хранит:
  - `paraIdx` (индекс строки/параграфа)
  - `raw` (оригинальная строка)
  - `tr` (перевод строки, который пользователь видел)
  - `createdAt`

UI показывает закладки сгруппированно по книге и помечает парой языков (для понимания, в каком пакете она была создана).

## 9) Cloudflare Worker (endpoint’ы)

### `/translate` (POST)
Запрос:
```json
{ "text": "...", "target": "uk", "noCache": false }
```
Ответ:
```json
{ "translatedText": "..." }
```

### `/tts` (POST)
Запрос:
```json
{ "text": "...", "voice": "onyx", "speed": 1.0, "instructions": "...", "format": "mp3", "noCache": false }
```
Ответ: аудио-байты (mp3/wav).

> Ключ OpenAI хранится в Worker Secrets (`OPENAI_API_KEY`).

